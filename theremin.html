<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Webカメラdeテルミン</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection"></script>
</head>
<body>
    <script>
        let video;
        let detector;
        let osc1, osc2, osc3;
        let isStarted = false;
        let targetFreq = 440;
        let targetVolume = 0.5;
        let currentFreq = 440;
        let currentVolume = 0.5;

        async function setup() {
            createCanvas(640, 480);
            video = createCapture(VIDEO);
            video.size(640, 480);
            
            osc1 = new p5.Oscillator('sine');
            osc2 = new p5.Oscillator('triangle');
            osc3 = new p5.Oscillator('sawtooth');
            
            osc1.disconnect();
            osc2.disconnect();
            osc3.disconnect();
            
            filter = new p5.LowPass();
            osc1.connect(filter);
            osc2.connect(filter);
            osc3.connect(filter);
            
            await initHandPoseDetection();
        }

        async function initHandPoseDetection() {
            detector = await handPoseDetection.createDetector(
                handPoseDetection.SupportedModels.MediaPipeHands,
                {
                    runtime: 'tfjs',
                    modelType: 'full',
                    maxHands: 2
                }
            );
        }

        async function detectHands() {
            const hands = await detector.estimateHands(video.elt);
            if (hands.length > 0) {
                let rightHand = hands.find(h => h.handedness === 'Right');
                let leftHand = hands.find(h => h.handedness === 'Left');

                if (rightHand) {
                    let rightHandY = rightHand.keypoints[0].y / height;
                    targetVolume = constrain(map(rightHandY, 1, 0, 0, 1), 0, 1);
                }
                if (leftHand) {
                    let leftHandY = leftHand.keypoints[0].y / height;
                    targetFreq = constrain(map(leftHandY, 1, 0, 100, 1000), 100, 1000);
                }
            }
        }

        function draw() {
            background(0);
            image(video, 0, 0, width, height);

            if (!isStarted) {
                fill(255, 0, 0);
                textSize(20);
                text("画面をクリックしてください", 20, 30);
                return;
            }

            detectHands();

            currentFreq = lerp(currentFreq, targetFreq, 0.1);
            currentVolume = lerp(currentVolume, targetVolume, 0.1);

            osc1.freq(currentFreq);
            osc2.freq(currentFreq * 1.01);
            osc3.freq(currentFreq * 0.99);

            osc1.amp(currentVolume * 0.6);
            osc2.amp(currentVolume * 0.3);
            osc3.amp(currentVolume * 0.4);

            filter.freq(500 + currentVolume * 1500);
            filter.res(2 + currentVolume * 3);

            fill(255);
            textSize(24);
            text(`Pitch: ${Math.round(currentFreq)} Hz`, 20, 30);
            text(`Volume: ${currentVolume.toFixed(2)}`, 20, 60);
        }

        function mousePressed() {
            if (!isStarted) {
                osc1.start();
                osc2.start();
                osc3.start();
                isStarted = true;
            }
        }
    </script>
</body>
</html>
